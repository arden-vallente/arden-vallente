<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:os="http://www.mulesoft.org/schema/mule/os" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/os http://www.mulesoft.org/schema/mule/os/current/mule-os.xsd">
	<sub-flow name="impl-site-to-dimension-sync-subflow" doc:id="adf98f0d-ec0a-47c8-a6af-17a0e9f53c2d" >
		<logger level="INFO" doc:name="START - GET Site Implem" doc:id="2d4aebab-28fd-4da8-acab-46dc6a9a94c6" category="${app.log.category}" message="START - GET Site Implem"/>
		<ee:transform doc:name="Set OS Key, DefaultValue, pageNo, resultSummary" doc:id="c6cecd10-eb2f-44b8-9004-c76eb2c7743a" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="objKey" ><![CDATA[%dw 2.0
output application/java
---
Mule::p('os.lastsyncdate.key')]]></ee:set-variable>
				<ee:set-variable variableName="defaultValue" ><![CDATA[%dw 2.0
output application/java
---
Mule::p('os.lastsyncdate.default')]]></ee:set-variable>
				<ee:set-variable variableName="pageNo" ><![CDATA[%dw 2.0
output application/java
---
1]]></ee:set-variable>
				<ee:set-variable variableName="pageSize" ><![CDATA[%dw 2.0
import p from Mule
output application/java
---
p('app.page.size') as Number]]></ee:set-variable>
				<ee:set-variable variableName="retrieveRecordCount" ><![CDATA[%dw 2.0
output application/java
---
0]]></ee:set-variable>
				<ee:set-variable variableName="resultSummary" ><![CDATA[%dw 2.0
output application/java
---
{
	success: 0,
	failed: 0
}]]></ee:set-variable>
			<ee:set-variable variableName="currentSyncDate" ><![CDATA[%dw 2.0
output application/java
---
now() as String {
	format : "yyyy-MM-dd'T'HH:mm:ss.SSSZ"
}]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<flow-ref doc:name="sys-object-store-api-get-record-subflow" doc:id="b7a8f8cf-c489-4f0b-9262-03a6f611a9f1" name="sys-object-store-api-get-record-subflow" target="lastSyncDate"/>
		<ee:transform doc:name="Set Paging Variables" doc:id="0e8df26f-3955-4248-9bfd-3666f3950451" >
			<ee:message>
			</ee:message>
			<ee:variables>
				<ee:set-variable variableName="pageNo" ><![CDATA[%dw 2.0
output application/java
---
1]]></ee:set-variable>
				<ee:set-variable variableName="pageSize" ><![CDATA[%dw 2.0
import p from Mule
output application/java
---
p('app.page.size') as Number]]></ee:set-variable>
				<ee:set-variable variableName="lastModifiedDate" ><![CDATA[%dw 2.0
output application/java
---
payload]]></ee:set-variable>
				<ee:set-variable variableName="totalRecordCount" ><![CDATA[%dw 2.0
output application/java
---
0]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<flow-ref doc:name="impl-site-to-dimension-paging-subflow" doc:id="7967d5f1-9ad5-4126-8402-308c2b3b8bb6" name="impl-site-to-dimension-paging-subflow"/>
		<logger level="INFO" doc:name="Log Project to Job Summary" doc:id="e4251ed2-a92a-4ee4-916b-df24a08ec52f" message="Project to Job Summary Result: #[vars.resultSummary] | Sync Date: #[vars.currentSyncDate]" category="${app.log.category}" />
		<ee:transform doc:name="Update Last Sync Date" doc:id="1f51a0d7-c9a5-43b6-83f8-5fa17e7c6529">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/java
---
vars.currentSyncDate]]></ee:set-payload>
					</ee:message>
				</ee:transform>
		<flow-ref doc:name="sys-object-store-api-store-record-subflow" doc:id="1ce7e94e-9cd2-416a-85e1-cc2b0ff127b7" name="sys-object-store-api-store-record-subflow" />
		<logger level="INFO" doc:name="END - GET Site Implem" doc:id="b5558996-eb16-4f85-9a83-64b488c95c79" message="END - GET Site Implem" category="${app.log.category}"/>
	</sub-flow>
	<sub-flow name="impl-site-to-dimension-paging-subflow" doc:id="e1545db1-81b1-4393-a3d5-9fc12f91eca4" >
		<logger level="INFO" doc:name="START - Get Site Impl Paging" doc:id="d7f0dd59-3053-418e-a74b-1c82fcc0e961" message="START - Get Site Impl Paging Subflow - PageNo: #[vars.pageNo] " category="${app.log.category}"/>
		<ee:transform doc:name="Set queryParams" doc:id="c2754586-0236-4ddb-8754-26147277fcb5" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="queryParams" ><![CDATA[%dw 2.0
import p from Mule
output application/json
---
{
	"pageEnabled": p('app.page.enabled') as Boolean,
	"pageNo": vars.pageNo as Number,
	"pageSize": p('app.page.size') as Number,
	"lastModifiedDate": vars.lastSyncDate
}]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<flow-ref doc:name="sys-sitetracker-api-get-site-flow" doc:id="fd78790e-5198-4481-ae89-8614dc4c609e" name="sys-sitetracker-api-get-site-subflow" target="site"/>
		<ee:transform doc:name="Set retrieveRecodCount" doc:id="ef697910-6c2b-479c-be68-de79916bc9c2">
			<ee:message>
			</ee:message>
			<ee:variables>
				<ee:set-variable variableName="retrieveRecordCount" ><![CDATA[%dw 2.0
output application/java
var totalRecords = vars.retrieveRecordCount + sizeOf(vars.site.data)
---
totalRecords]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<choice doc:name="Site Record Found?" doc:id="fbaec6b3-4db4-4c7d-aa68-9d6e2d7bcb94" >
			<when expression="#[sizeOf(vars.site.data) &gt; 0]">
				<foreach doc:name="For Each Site Record" doc:id="0c8f8338-e421-451e-8776-9558575b3ca0" collection="#[vars.site.data]">
					<choice doc:name="SiteCode is not empty?" doc:id="e17ada41-5082-49af-bf1f-82088b90bb91" >
						<when expression="#[!isEmpty(payload.siteCode)]">
						<try doc:name="Try" doc:id="f64ab517-7caa-42a1-8494-8d572974998c" >
						<ee:transform doc:name="Set bcQueryParams" doc:id="1648964e-0779-41b2-a449-3bd6c1d034fc">
						<ee:message>
						</ee:message>
							<ee:variables>
								<ee:set-variable variableName="bcQueryParams"><![CDATA[%dw 2.0
output application/json
---
{
	filter: "code eq '$(payload.siteCode)'"
}]]></ee:set-variable>
							</ee:variables>
					</ee:transform>
						<flow-ref doc:name="sys-business-central-api-get-dimension-subflow" doc:id="2ba18ceb-9eb2-4217-8dc0-06a3f22f4ecf" name="sys-business-central-api-get-dimension-subflow" target="dimension"/>
						<choice doc:name="Dimension Already Exist?" doc:id="744f4d4b-2ecc-4183-9f29-9c3caf61a032" >
							<when expression="#[sizeOf(vars.dimension.data) &gt; 0]">
								<ee:transform doc:name="Set Update Dimension Payload" doc:id="f99bada9-a9a6-450e-bb6e-9e1cffae13bb">
			<ee:message>
										<ee:set-payload resource="dwl/request/dwl-update-dimension-request.dwl" />
			</ee:message>
									<ee:variables >
										<ee:set-variable variableName="uriParams" ><![CDATA[%dw 2.0
output application/java
var dimension = vars.dimension.data
---
{
	dimensionId: dimension[0].systemId
}]]></ee:set-variable>
									</ee:variables>
		</ee:transform>
								<flow-ref doc:name="sys-business-central-api-update-dimension-subflow" doc:id="77325261-534f-4d84-a1f3-234a16187910" name="sys-business-central-api-update-dimension-subflow" />
							</when>
							<otherwise >
								<ee:transform doc:name="Set Create Dimension Payload" doc:id="d6e224ff-0207-4b89-b0e0-e28c68fc4e07" >
									<ee:message >
										<ee:set-payload resource="dwl/request/dwl-create-dimension-request.dwl" />
									</ee:message>
								</ee:transform>
								<flow-ref doc:name="sys-business-central-api-create-dimension-subflow" doc:id="4fd23077-52ab-42db-a0ec-eb4d9b36adf4" name="sys-business-central-api-create-dimension-subflow" />
							</otherwise>
						</choice>
						<ee:transform doc:name="Update Result Summary" doc:id="a3c28160-4728-46e9-8b44-0a45f759499c">
					<ee:message />
					<ee:variables>
						<ee:set-variable variableName="resultSummary"><![CDATA[%dw 2.0
output application/java
var summary = vars.resultSummary
---
{
	success: ((summary.success default 0) + 1),
	failed: summary.failed,
	emptySiteCode: summary.emptySiteCode 
}]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
						<error-handler >
							<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="60a70564-6ccf-425a-8514-a28bf97d65b6" >
								<logger level="ERROR" doc:name="ERROR - Process Site Record" doc:id="e7227844-0773-4ddb-b120-6355a2c9896f" message="ERROR - Process Site Record Exception: " category="${app.log.category.error}"/>
								<ee:transform doc:name="Update Result Summary" doc:id="91ae638b-62eb-4e79-a80e-ec25b12310b2" >
									<ee:message >
									</ee:message>
									<ee:variables >
										<ee:set-variable variableName="resultSummary" ><![CDATA[%dw 2.0
output application/java
var summary = vars.resultSummary
---
{
	success: summary.success,
	failed: ((summary.failed default 0) + 1),
	emptySiteCode: summary.emptySiteCode 
}]]></ee:set-variable>
									</ee:variables>
								</ee:transform>
							</on-error-continue>
						</error-handler>
					</try>
						</when>
						<otherwise >
							<logger level="INFO" doc:name="No Site Code Found" doc:id="be1bbe6a-aa41-449b-80d7-de316b7530f1" message='#[output application/json&#10;---&#10;"No Site Code Found - $(payload.id)"]' category="${app.log.category}"/>
							<ee:transform doc:name="Update Result Summary" doc:id="d7fd11f4-9522-4bc2-9557-fa08d3e59108" >
								<ee:message />
								<ee:variables >
									<ee:set-variable variableName="resultSummary" ><![CDATA[%dw 2.0
output application/java
var summary = vars.resultSummary
---
{
	success: summary.success,
	failed: summary.failed,
	emptySiteCode: ((summary.emptySiteCode default 0) + 1)
}]]></ee:set-variable>
								</ee:variables>
							</ee:transform>
						</otherwise>
					</choice>
					
				</foreach>
				</when>
				<otherwise >
					<logger level="INFO" doc:name="No Site Found" doc:id="67cd0916-4dd5-4d3a-8bd6-7bcf4885a86c" message="No Site Found" category="${app.log.category}"/>
				</otherwise>
				</choice>
				<choice doc:name="Check pageNo" doc:id="f8fcaf40-7973-4d30-865d-5fa245bef7a3">
			<when expression="#[sizeOf(vars.site.data) == p('app.page.size') as Number]">
				<ee:transform doc:name="Set pageNo" doc:id="6864060c-5cee-46b7-baab-695d695ee367">
					<ee:message>
					</ee:message>
					<ee:variables>
						<ee:set-variable variableName="pageNo"><![CDATA[%dw 2.0
output application/java
var nextPage = vars.pageNo as Number + 1
---
nextPage]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
				<logger level="INFO" doc:name="With next page" doc:id="cb757823-fcbd-42dd-a4ed-a17f7f91a948" message="With next page branch. Next pageNo :  #[vars.pageNo] " category="${app.log.category}" />
				<flow-ref doc:name="impl-site-to-dimension-paging-subflow" doc:id="0e2079bc-9440-48d0-9392-d5f3caf105b5" name="impl-site-to-dimension-paging-subflow" />
			</when>
			<otherwise>
				<logger level="INFO" doc:name="Last page" doc:id="54f79cc0-e787-4933-8209-4be89b40f2db" message="Last page. Record count: #[sizeOf(vars.site.data)] | Total Records: #[vars.retrieveRecordCount]" category="${app.log.category}"/>
				<logger level="INFO" doc:name="END - Get Project Impl Paging" doc:id="9897163c-3bd2-4f9b-a286-32dd930e4cab" message="END - Get Project Impl Paging Subflow - PageNo: #[vars.pageNo] " category="${app.log.category}" />
			</otherwise>
		</choice>
	</sub-flow>
	
</mule>
